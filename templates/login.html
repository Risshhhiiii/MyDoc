{% extends "base.html" %}
{% block title %}Login{% endblock title %}
{% block body %}

<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{background:linear-gradient(135deg,#b6d0ff,#e3f0ff 60%,#fafdff);}

  .page-wrapper{
    min-height:calc(100vh - 70px);
    display:flex;justify-content:center;align-items:center;
    padding-top:20px;
  }

  .login-container{
    width:90%;max-width:420px;background:rgba(255,255,255,0.82);
    padding:35px 30px;border-radius:20px;
    box-shadow:0 8px 25px rgba(0,0,0,0.15);
    animation:slideIn 1s ease;
  }

  @keyframes slideIn{
    from{opacity:0;transform:translateY(50px);}
    to{opacity:1;transform:translateY(0);}
  }

  h2{
    text-align:center;font-size:2rem;margin-bottom:20px;
    background:linear-gradient(90deg,#2196f3,#174ea6,#b6d0ff);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }

  .dropdown-role {
    width:100%;padding:12px;border-radius:12px;border:none;
    background:white;box-shadow:0 2px 6px rgba(33,150,243,0.1);
    font-size:1rem;margin-bottom:18px;
  }

  .form-group input{
    width:100%;padding:14px 12px;border:none;border-radius:12px;
    background:white;
    box-shadow:0 2px 6px rgba(33,150,243,0.1);
    font-size:1rem;transition:0.3s;
  }

  .form-group input:focus{
    box-shadow:0 4px 14px rgba(33,150,243,0.25);
    transform:scale(1.02);outline:none;
  }

  .login-btn{
    width:100%;padding:14px;border:none;border-radius:12px;
    background:linear-gradient(90deg,#2196f3,#174ea6);color:#fff;
    font-size:1.1rem;cursor:pointer;margin-top:5px;
  }

  .login-btn:hover{
    transform:translateY(-3px);
    box-shadow:0 6px 18px rgba(33,150,243,0.35);
  }

  .popup{
    position:fixed;top:50%;left:50%;
    transform:translate(-50%,-50%) scale(0.8);
    background:white;padding:20px 30px;border-radius:16px;
    box-shadow:0 8px 30px rgba(33,150,243,0.3);
    font-size:1.1rem;color:#174ea6;text-align:center;
    opacity:0;pointer-events:none;
    transition:opacity 0.4s ease,transform 0.4s ease;z-index:1000;
  }
  .popup.show{
    opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1);
  }

  .overlay {
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.45);
    display:none;justify-content:center;align-items:center;
    z-index:2000;
  }
  .overlay.active{display:flex;}

  .overlay-box{
    background:white;padding:25px;border-radius:20px;
    width:90%;max-width:350px;
    box-shadow:0 8px 25px rgba(0,0,0,0.3);
    animation:popIn 0.3s ease;
  }

  @keyframes popIn { 
    from{transform:scale(0.85);opacity:0;} 
    to{transform:scale(1);opacity:1;} 
  }

  .overlay-box h2{
    margin-bottom:15px;font-size:1.5rem;color:#174ea6;text-align:center;
  }
  .overlay-box input{
    width:100%;padding:12px;margin-bottom:12px;border:none;
    border-radius:12px;background:#f1f5f9;font-size:1rem;
  }
  .overlay-box button{
    width:100%;padding:12px;border:none;border-radius:12px;
    background:#2196f3;color:white;font-size:1rem;
  }
</style>

<a id="safeOpen" href="#" target="_blank" style="display:none;"></a>

<div class="popup" id="popupMessage"></div>

<div class="overlay" id="registerOverlay">
  <div class="overlay-box">
    <h2>Create Account</h2>
    <input type="text" id="regUsername" placeholder="Create Username">
    <input type="password" id="regPassword" placeholder="Create Password">
    <button id="registerBtn">Register</button>
    <button onclick="closeRegister()" style="margin-top:10px;background:#ccc;color:black;">Cancel</button>
  </div>
</div>

<div class="page-wrapper">
  <div class="login-container">

    <h2>Login</h2>

    <select id="roleSelect" class="dropdown-role">
      <option value="" disabled selected>Select role</option>
      <option value="user">Patient</option>
      <option value="doctor">Doctor</option>
      <option value="admin">Admin</option>
    </select>

    <form id="loginForm">
      <div class="form-group">
        <input type="text" id="username" placeholder="Username" required>
      </div>

      <div class="form-group">
        <input type="password" id="password" placeholder="Password" required>
      </div>

      <button type="submit" class="login-btn">Login</button>
    </form>

    <p style="text-align:center;margin-top:10px;">
      <span id="newUserMsg" style="color:#f00;display:none;">
        User not registered. <a href="#" onclick="openRegister()">Register?</a>
      </span>
    </p>

  </div>
</div>

<script>
let selectedRole = null;
document.getElementById("roleSelect").onchange = (e)=> selectedRole = e.target.value;

function showPopup(msg, color="green"){
  const popup = document.getElementById("popupMessage");
  popup.style.color = color;
  popup.textContent = msg;
  popup.classList.add("show");
  setTimeout(()=> popup.classList.remove("show"), 2500);
}

function openRegister(){ document.getElementById("registerOverlay").classList.add("active"); }
function closeRegister(){ document.getElementById("registerOverlay").classList.remove("active"); }

function openSafe(url){
  const win = window.open("about:blank", "_blank");
  win.location.href = url;
}

// --------------------------------------------
// REGISTER (FIXED ENDPOINT BELOW)
// --------------------------------------------
document.getElementById("registerBtn").onclick = async ()=>{
  const username = document.getElementById("regUsername").value.trim().toLowerCase();
  const password = document.getElementById("regPassword").value.trim();

  if(!username || !password){
    showPopup("Enter all fields","red");
    return;
  }

  const res = await fetch("/api/user/login-register/",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username, password, register:true })
  });

  const data = await res.json();

  if(res.ok){
    closeRegister();
    showPopup("Registration successful!");
    localStorage.setItem("username", username);
    openSafe(`/user_dashboard/?user=${username}`);
  } else showPopup(data.error, "red");
};

// --------------------------------------------
// LOGIN (FIXED ENDPOINT BELOW)
// --------------------------------------------
document.getElementById("loginForm").onsubmit = async (e)=>{
  e.preventDefault();
  document.getElementById("newUserMsg").style.display="none";

  const username = document.getElementById("username").value.trim().toLowerCase();
  const password = document.getElementById("password").value.trim();

  if(!selectedRole){
    showPopup("Please select role","red");
    return;
  }

  let endpoint = "";
  if(selectedRole==="user")   endpoint="/api/user/login-register/";
  if(selectedRole==="doctor") endpoint="/api/doctor/login/";
  if(selectedRole==="admin")  endpoint="/api/admin/login/";

  const response = await fetch(endpoint,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username, password })
  });

  const data = await response.json();

  if(selectedRole==="user" && data.error==="user not found"){
    document.getElementById("newUserMsg").style.display="inline";
    return;
  }

  if(!response.ok){
    showPopup(data.error || "Login failed","red");
    return;
  }

  if(selectedRole==="doctor") localStorage.setItem("doctor", username);
  else localStorage.setItem("username", username);

  showPopup("Login successful!");

  if(selectedRole==="user")   openSafe(`/user_dashboard/?user=${username}`);
  if(selectedRole==="doctor") openSafe("/doctor_dashboard/");
  if(selectedRole==="admin")  openSafe("/admin_dashboard/");
};
</script>

{% endblock body %}
